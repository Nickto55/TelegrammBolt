{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ - BOLT{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3">
                <i class="bi bi-people"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
            </h1>
        </div>
    </div>
    
    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-person-lines-fill"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>–ò–º—è</th>
                                    <th>Username</th>
                                    <th>–†–æ–ª—å</th>
                                    <th>–ü—Ä–∞–≤–∞</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user_id, user_data in users.items() %}
                                <tr>
                                    <td><code>{{ user_id }}</code></td>
                                    <td>{{ user_data.get('first_name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') }} {{ user_data.get('last_name', '') }}</td>
                                    <td>
                                        {% if user_data.get('username') %}
                                        @{{ user_data.username }}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if user_data.get('role') == 'admin' %}bg-danger
                                            {% elif user_data.get('role') == 'responder' %}bg-success
                                            {% elif user_data.get('role') == 'initiator' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ roles.get(user_data.get('role', 'user'), '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å') }}
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ user_data.get('permissions', []) | length }} –ø—Ä–∞–≤
                                        </small>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1" 
                                                onclick="editUser('{{ user_id }}', {{ user_data | tojson }})">
                                            <i class="bi bi-pencil"></i> –ò–∑–º–µ–Ω–∏—Ç—å
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteUser('{{ user_id }}', '{{ user_data.get('first_name', '') }} {{ user_data.get('last_name', '') }}')"
                                                {% if user_id == session['user_id']|string %}disabled title="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–µ–±—è"{% endif %}>
                                            <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∞–≤</h5>
                    <button class="btn btn-sm btn-light" onclick="loadPermissionsLog()">
                        <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
                <div class="card-body">
                    <div id="permissionsLog">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-person-gear"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</h6>
                    <p id="editUserName" class="text-muted mb-0"></p>
                    <small id="editUserId" class="text-muted"></small>
                </div>
                
                <div class="mb-3">
                    <label for="editUserRole" class="form-label">–†–æ–ª—å:</label>
                    <select class="form-select" id="editUserRole">
                        <option value="user">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                        <option value="initiator">üìù –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä –∑–∞—è–≤–æ–∫</option>
                        <option value="responder">üîß –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</option>
                        <option value="admin">‚≠ê –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                    <small class="form-text text-muted">
                        –†–æ–ª—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    </small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="perm_view_dse" value="view_dse">
                        <label class="form-check-label" for="perm_view_dse">
                            –ü—Ä–æ—Å–º–æ—Ç—Ä –î–°–ï
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="perm_export_data" value="export_data">
                        <label class="form-check-label" for="perm_export_data">
                            –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="perm_add_dse" value="add_dse">
                        <label class="form-check-label" for="perm_add_dse">
                            –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –î–°–ï
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="perm_edit_dse" value="edit_dse">
                        <label class="form-check-label" for="perm_edit_dse">
                            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –î–°–ï
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="perm_delete_dse" value="delete_dse">
                        <label class="form-check-label" for="perm_delete_dse">
                            –£–¥–∞–ª–µ–Ω–∏–µ –î–°–ï
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="perm_chat_dse" value="chat_dse">
                        <label class="form-check-label" for="perm_chat_dse">
                            –ß–∞—Ç –ø–æ –î–°–ï
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveUserPermissions()">
                    <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentEditingUserId = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadPermissionsLog();
});

function editUser(userId, userData) {
    currentEditingUserId = userId;
    
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    document.getElementById('editUserName').textContent = 
        (userData.first_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') + ' ' + (userData.last_name || '');
    document.getElementById('editUserId').textContent = 'ID: ' + userId;
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π —Ä–æ–ª–∏
    document.getElementById('editUserRole').value = userData.role || 'user';
    
    // –°–±—Ä–æ—Å –≤—Å–µ—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
    document.querySelectorAll('.form-check-input').forEach(cb => cb.checked = false);
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–∏—Ö –ø—Ä–∞–≤
    const permissions = userData.permissions || [];
    permissions.forEach(perm => {
        const checkbox = document.getElementById('perm_' + perm);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
    modal.show();
}

function saveUserPermissions() {
    if (!currentEditingUserId) return;
    
    const newRole = document.getElementById('editUserRole').value;
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞
    const selectedPermissions = [];
    document.querySelectorAll('.form-check-input:checked').forEach(cb => {
        selectedPermissions.push(cb.value);
    });
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch(`/api/users/${currentEditingUserId}/permissions`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            role: newRole,
            permissions: selectedPermissions
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const modalElement = document.getElementById('editUserModal');
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                modalInstance.hide();
            }
            
            // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            alert('‚úÖ –ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            location.reload();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π');
    });
}

function deleteUser(userId, userName) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userName}?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
        return;
    }
    
    fetch(`/api/users/${userId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
            location.reload();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    });
}

function loadPermissionsLog() {
    const logContainer = document.getElementById('permissionsLog');
    
    fetch('/api/permissions/log')
        .then(response => response.json())
        .then(data => {
            if (data.length === 0) {
                logContainer.innerHTML = '<p class="text-center text-muted py-4">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—É—Å—Ç–∞</p>';
                return;
            }
            
            let html = '<div class="timeline">';
            
            data.slice(0, 50).forEach(log => {
                const roleChange = log.changes.role;
                html += `
                    <div class="timeline-item mb-3 p-3 border-start border-3 border-primary">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong>${log.admin_name}</strong> 
                                <span class="text-muted">–∏–∑–º–µ–Ω–∏–ª –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                                <strong>${log.target_name}</strong>
                            </div>
                            <small class="text-muted">${log.timestamp}</small>
                        </div>
                        <div class="text-muted small">
                            <div>
                                –†–æ–ª—å: 
                                <span class="badge bg-secondary">${getRoleName(roleChange.old)}</span>
                                <i class="bi bi-arrow-right"></i>
                                <span class="badge bg-primary">${getRoleName(roleChange.new)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            logContainer.innerHTML = html;
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
            logContainer.innerHTML = '<p class="text-center text-danger py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</p>';
        });
}

function getRoleName(role) {
    const roles = {
        'admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
        'responder': '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π',
        'initiator': '–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä',
        'user': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
    };
    return roles[role] || role;
}
</script>

<style>
.timeline-item {
    background-color: #f8f9fa;
    border-radius: 8px;
}

.timeline-item:hover {
    background-color: #e9ecef;
    transition: background-color 0.3s ease;
}
</style>
{% endblock %}

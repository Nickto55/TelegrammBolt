{% extends "base.html" %}

{% block title %}Панель управления - TelegrammBolt{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-speedometer2"></i> Панель управления
            </h1>
        </div>
    </div>
    
    <!-- Статистика -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Всего ДСЕ</h6>
                            <h2 class="card-title mb-0">{{ stats.total_dse }}</h2>
                        </div>
                        <i class="bi bi-list-ul display-4 opacity-50"></i>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <a href="{{ url_for('dse_list') }}" class="text-white text-decoration-none">
                        Перейти к списку <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Активные чаты</h6>
                            <h2 class="card-title mb-0">{{ stats.active_chats }}</h2>
                        </div>
                        <i class="bi bi-chat-dots display-4 opacity-50"></i>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <a href="{{ url_for('chat') }}" class="text-white text-decoration-none">
                        Открыть чат <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Отчетов создано</h6>
                            <h2 class="card-title mb-0">{{ stats.reports_generated }}</h2>
                        </div>
                        <i class="bi bi-file-earmark-text display-4 opacity-50"></i>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <a href="{{ url_for('reports') }}" class="text-white text-decoration-none">
                        Создать отчет <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Быстрые действия -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Быстрые действия</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% if permissions.add_dse %}
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary w-100 py-3" onclick="addNewDse()">
                                <i class="bi bi-plus-circle display-6 d-block mb-2"></i>
                                Добавить ДСЕ
                            </button>
                        </div>
                        {% endif %}
                        
                        {% if permissions.export_data %}
                        <div class="col-md-3">
                            <button class="btn btn-outline-success w-100 py-3" onclick="exportExcel()">
                                <i class="bi bi-file-earmark-excel display-6 d-block mb-2"></i>
                                Экспорт Excel
                            </button>
                        </div>
                        
                        <div class="col-md-3">
                            <button class="btn btn-outline-danger w-100 py-3" onclick="generatePdf()">
                                <i class="bi bi-file-earmark-pdf display-6 d-block mb-2"></i>
                                Создать PDF
                            </button>
                        </div>
                        {% endif %}
                        
                        {% if permissions.chat_dse %}
                        <div class="col-md-3">
                            <a href="{{ url_for('chat') }}" class="btn btn-outline-info w-100 py-3">
                                <i class="bi bi-chat-left-text display-6 d-block mb-2"></i>
                                Открыть чат
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Последние ДСЕ -->
    {% if permissions.view_dse %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Последние ДСЕ</h5>
                    <a href="{{ url_for('dse_list') }}" class="btn btn-sm btn-primary">
                        Показать все
                    </a>
                </div>
                <div class="card-body">
                    <div id="recent-dse">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Загрузка последних ДСЕ
document.addEventListener('DOMContentLoaded', function() {
    loadRecentDse();
});

function loadRecentDse() {
    fetch('/api/dse')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('recent-dse');
            if (data.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Нет данных для отображения</p>';
                return;
            }
            
            // Показать последние 5
            const recent = data.slice(0, 5);
            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead><tr><th>ID</th><th>Название</th><th>Статус</th><th>Дата</th><th>Действия</th></tr></thead><tbody>';
            
            recent.forEach(dse => {
                html += `
                    <tr>
                        <td>${dse.id}</td>
                        <td>${dse.name || 'Без названия'}</td>
                        <td><span class="badge bg-info">${dse.status || 'Активно'}</span></td>
                        <td>${dse.date || '-'}</td>
                        <td>
                            <a href="/dse/${dse.id}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading DSE:', error);
            document.getElementById('recent-dse').innerHTML = 
                '<p class="text-center text-danger">Ошибка загрузки данных</p>';
        });
}

function addNewDse() {
    // TODO: Открыть модальное окно для добавления ДСЕ
    alert('Функция добавления ДСЕ будет реализована');
}

function exportExcel() {
    window.location.href = '/api/export/excel';
}

function generatePdf() {
    // TODO: Открыть диалог генерации PDF
    alert('Функция генерации PDF будет реализована');
}
</script>
{% endblock %}

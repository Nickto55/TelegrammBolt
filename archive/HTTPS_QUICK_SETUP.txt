╔══════════════════════════════════════════════════════════════╗
║  🔒 БЫСТРАЯ НАСТРОЙКА HTTPS                                  ║
╚══════════════════════════════════════════════════════════════╝

ЦЕЛЬ: Настроить HTTPS для доступа по адресу https://87.120.166.213


═══════════════════════════════════════════════════════════════
 ⚡ АВТОМАТИЧЕСКАЯ УСТАНОВКА (1 КОМАНДА)
═══════════════════════════════════════════════════════════════

# Скопируйте скрипт на сервер и запустите:
sudo bash setup-https.sh


═══════════════════════════════════════════════════════════════
 🛠️ РУЧНАЯ УСТАНОВКА (Шаг за шагом)
═══════════════════════════════════════════════════════════════

Шаг 1: Создать SSL сертификат
---------------------------------------------------------------
sudo mkdir -p /etc/nginx/ssl

sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /etc/nginx/ssl/telegrambot.key \
  -out /etc/nginx/ssl/telegrambot.crt \
  -subj "/C=RU/ST=Moscow/L=Moscow/O=TelegrammBolt/CN=87.120.166.213"


Шаг 2: Установить Nginx (если не установлен)
---------------------------------------------------------------
sudo apt update
sudo apt install nginx


Шаг 3: Создать конфигурацию Nginx
---------------------------------------------------------------
sudo nano /etc/nginx/sites-available/telegrambot

# Вставить (скопируйте из nginx-ssl.conf):

server {
    listen 80;
    server_name 87.120.166.213;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name 87.120.166.213;
    
    ssl_certificate /etc/nginx/ssl/telegrambot.crt;
    ssl_certificate_key /etc/nginx/ssl/telegrambot.key;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    client_max_body_size 16M;
    
    location /static/ {
        alias /opt/telegrambot/static/;
    }
    
    location /photos/ {
        alias /opt/telegrambot/photos/;
    }
    
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Сохранить: Ctrl+O, Enter, Ctrl+X


Шаг 4: Активировать конфигурацию
---------------------------------------------------------------
sudo ln -sf /etc/nginx/sites-available/telegrambot /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl restart nginx


Шаг 5: Открыть порты
---------------------------------------------------------------
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw reload


═══════════════════════════════════════════════════════════════
 ✅ ПРОВЕРКА
═══════════════════════════════════════════════════════════════

# 1. Проверить что Nginx работает
sudo systemctl status nginx

# 2. Проверить порты
sudo netstat -tulpn | grep nginx
# Должно быть: :80 и :443

# 3. Проверить HTTPS
curl -k https://87.120.166.213

# 4. Открыть в браузере
https://87.120.166.213


═══════════════════════════════════════════════════════════════
 ⚠️ ВАЖНО
═══════════════════════════════════════════════════════════════

1. Браузер покажет предупреждение о небезопасном сертификате
   (это нормально для самоподписанного сертификата)
   
   Нажмите: "Дополнительно" → "Продолжить на сайт"

2. Убедитесь что веб-приложение запущено:
   cd /opt/telegrambot
   source .venv/bin/activate
   gunicorn -w 4 -b 0.0.0.0:5000 web_app:app

3. Обновите домен в @BotFather:
   /setdomain → 87.120.166.213


═══════════════════════════════════════════════════════════════
 🐳 ДЛЯ DOCKER
═══════════════════════════════════════════════════════════════

Если используете Docker, выполните настройку Nginx на хосте
(не в контейнере), а приложение запускайте в Docker на порту 5000


═══════════════════════════════════════════════════════════════
 🆘 РЕШЕНИЕ ПРОБЛЕМ
═══════════════════════════════════════════════════════════════

Ошибка: nginx: [emerg] bind() to 0.0.0.0:443 failed
---------------------------------------------------------------
# Порт занят, найти что занимает:
sudo lsof -i :443
sudo kill <PID>
sudo systemctl restart nginx


Ошибка: ERR_SSL_PROTOCOL_ERROR
---------------------------------------------------------------
# Проверить что сертификаты на месте:
ls -la /etc/nginx/ssl/
# Должны быть: telegrambot.crt и telegrambot.key

# Проверить права:
sudo chmod 644 /etc/nginx/ssl/telegrambot.crt
sudo chmod 600 /etc/nginx/ssl/telegrambot.key


Ошибка: 502 Bad Gateway
---------------------------------------------------------------
# Приложение не запущено или недоступно на порту 5000
# Проверить:
curl http://localhost:5000

# Запустить приложение:
cd /opt/telegrambot
source .venv/bin/activate
gunicorn -w 4 -b 0.0.0.0:5000 web_app:app


═══════════════════════════════════════════════════════════════
 📋 ЛОГИ
═══════════════════════════════════════════════════════════════

# Логи Nginx
sudo tail -f /var/log/nginx/telegrambot_error.log
sudo tail -f /var/log/nginx/telegrambot_access.log

# Логи приложения
tail -f /opt/telegrambot/web.log


═══════════════════════════════════════════════════════════════
 ✅ ПОСЛЕ НАСТРОЙКИ
═══════════════════════════════════════════════════════════════

Ваш сайт будет доступен по адресу:
  🔒 https://87.120.166.213

HTTP автоматически перенаправляется на HTTPS:
  http://87.120.166.213 → https://87.120.166.213

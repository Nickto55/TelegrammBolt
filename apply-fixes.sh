#!/bin/bash

# üöÄ –ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
# –î–∞—Ç–∞: $(date)

echo "=================================================="
echo "üîß –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô –î–õ–Ø TELEGRAM –ë–û–¢–ê"
echo "=================================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -d "/opt/telegrambot" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /opt/telegrambot –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    exit 1
fi

cd /opt/telegrambot

echo "üìç –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo ""

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞..."
pkill -f "python.*bot.py" 2>/dev/null
pkill -f "python.*web_app.py" 2>/dev/null
sleep 2

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤..."
PORT_5000=$(lsof -ti:5000 2>/dev/null)
if [ ! -z "$PORT_5000" ]; then
    echo "‚ö†Ô∏è  –ü–æ—Ä—Ç 5000 –∑–∞–Ω—è—Ç (PID: $PORT_5000), –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º..."
    kill -9 $PORT_5000 2>/dev/null
    sleep 1
fi

# –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"
cp commands.py "$BACKUP_DIR/"
cp pdf_generator.py "$BACKUP_DIR/"
echo "   –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: $BACKUP_DIR"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Python –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üêç –ü—Ä–æ–≤–µ—Ä–∫–∞ Python –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
if [ -d "venv" ]; then
    source venv/bin/activate
    echo "   ‚úÖ Virtual environment –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"
elif [ -d ".venv" ]; then
    source .venv/bin/activate
    echo "   ‚úÖ Virtual environment –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"
else
    echo "   ‚ö†Ô∏è  Virtual environment –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π Python"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
python -c "import telegram, flask, reportlab" 2>/dev/null
if [ $? -ne 0 ]; then
    echo "   ‚ö†Ô∏è  –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    pip install python-telegram-bot flask reportlab pillow psutil -q
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo "‚öôÔ∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
if [ ! -f "ven_bot.json" ]; then
    echo "   ‚ùå –û—à–∏–±–∫–∞: ven_bot.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

BOT_USERNAME=$(python -c "import json; print(json.load(open('ven_bot.json')).get('BOT_USERNAME', ''))" 2>/dev/null)
if [ -z "$BOT_USERNAME" ]; then
    echo "   ‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: BOT_USERNAME –ø—É—Å—Ç–æ–π –≤ ven_bot.json"
    echo "   üìù –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤–µ–±-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
fi

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
nohup python bot.py > bot.log 2>&1 &
BOT_PID=$!

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (5 —Å–µ–∫—É–Ω–¥)..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
if ps -p $BOT_PID > /dev/null; then
    echo ""
    echo "=================================================="
    echo "‚úÖ –ë–û–¢ –£–°–ü–ï–®–ù–û –ó–ê–ü–£–©–ï–ù!"
    echo "=================================================="
    echo ""
    echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
    echo "   - PID: $BOT_PID"
    echo "   - –õ–æ–≥–∏: tail -f bot.log"
    echo "   - Web: http://localhost:5000 (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)"
    echo ""
    echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:"
    echo ""
    echo "   1Ô∏è‚É£  –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
    echo "      - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ‚Üí –ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å"
    echo "      - –í—ã–±—Ä–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –í—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å"
    echo "      - ‚úÖ –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å: '–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: [–†–æ–ª—å]'"
    echo ""
    echo "   2Ô∏è‚É£  –í—ã–±–æ—Ä–æ—á–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç PDF:"
    echo "      - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ‚Üí –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF"
    echo "      - –í—ã–±—Ä–∞—Ç—å –∑–∞–ø–∏—Å–∏ ‚Üí –í—ã–±—Ä–∞—Ç—å –î–°–ï"
    echo "      - –≠–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö"
    echo "      - ‚úÖ –î–æ–ª–∂–Ω—ã –ø—Ä–∏–π—Ç–∏ PDF —Ñ–∞–π–ª—ã"
    echo ""
    echo "üìù –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
    echo "   - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: pkill -f 'python.*bot.py'"
    echo "   - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å: bash apply-fixes.sh"
    echo "   - –õ–æ–≥–∏: tail -f bot.log"
    echo "   - –ú–æ–Ω–∏—Ç–æ—Ä: python monitor.py"
    echo ""
    echo "=================================================="
else
    echo ""
    echo "‚ùå –û–®–ò–ë–ö–ê –ó–ê–ü–£–°–ö–ê –ë–û–¢–ê"
    echo "=================================================="
    echo ""
    echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
    echo "   tail -50 bot.log"
    echo ""
    echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞:"
    tail -20 bot.log
    echo ""
    echo "üõ†Ô∏è  –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "   - –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ ven_bot.json"
    echo "   - –ü–æ—Ä—Ç 5000 –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º"
    echo "   - –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python"
    echo "   - –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ"
    echo ""
    exit 1
fi

echo "‚ú® –ì–æ—Ç–æ–≤–æ!"

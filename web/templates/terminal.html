{% extends "base.html" %}

{% block title %}–í–µ–±-—Ç–µ—Ä–º–∏–Ω–∞–ª - TelegrammBolt{% endblock %}

{% block extra_head %}
<!-- Xterm.js –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>

<!-- Socket.IO –¥–ª—è WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<style>
    .terminal-container {
        background-color: #1e1e1e;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .terminal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        margin: -20px -20px 0 -20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .terminal-header h2 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
    }

    .terminal-controls {
        display: flex;
        gap: 10px;
    }

    .terminal-btn {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .terminal-btn.start {
        background-color: #10b981;
        color: white;
    }

    .terminal-btn.start:hover {
        background-color: #059669;
    }

    .terminal-btn.stop {
        background-color: #ef4444;
        color: white;
    }

    .terminal-btn.stop:hover {
        background-color: #dc2626;
    }

    .terminal-btn.clear {
        background-color: #6b7280;
        color: white;
    }

    .terminal-btn.clear:hover {
        background-color: #4b5563;
    }

    .terminal-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    #terminal {
        margin-top: 20px;
        height: 500px;
        border-radius: 0 0 8px 8px;
    }

    .terminal-info {
        background-color: #f3f4f6;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .terminal-info h3 {
        margin: 0 0 10px 0;
        color: #374151;
        font-size: 1rem;
    }

    .terminal-info ul {
        margin: 0;
        padding-left: 20px;
        color: #6b7280;
    }

    .terminal-info li {
        margin: 5px 0;
    }

    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-indicator.connected {
        background-color: #10b981;
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
    }

    .status-indicator.disconnected {
        background-color: #ef4444;
    }

    .status-text {
        font-size: 0.9rem;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1>
                <i class="fas fa-terminal"></i> –í–µ–±-—Ç–µ—Ä–º–∏–Ω–∞–ª
            </h1>

            <div class="terminal-info">
                <h3><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <ul>
                    <li>–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –∫–æ–º–∞–Ω–¥–Ω–æ–π –æ–±–æ–ª–æ—á–∫–µ —Å–µ—Ä–≤–µ—Ä–∞</li>
                    <li>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π</li>
                    <li>–î–ª—è Windows –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è PowerShell, –¥–ª—è Linux/Unix - Bash</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</li>
                    <li><strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏</li>
                </ul>
            </div>

            <div class="terminal-container">
                <div class="terminal-header">
                    <div>
                        <h2>
                            <i class="fas fa-code"></i>
                            Shell Terminal
                            <span class="status-indicator disconnected" id="status-indicator"></span>
                            <span class="status-text" id="status-text">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
                        </h2>
                    </div>
                    <div class="terminal-controls">
                        <button class="terminal-btn start" id="start-btn" onclick="startTerminal()">
                            <i class="fas fa-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å
                        </button>
                        <button class="terminal-btn stop" id="stop-btn" onclick="stopTerminal()" disabled>
                            <i class="fas fa-stop"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                        <button class="terminal-btn clear" id="clear-btn" onclick="clearTerminal()">
                            <i class="fas fa-eraser"></i> –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                    </div>
                </div>
                <div id="terminal"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let term;
    let fitAddon;
    let socket;
    let isConnected = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function () {
        initTerminal();
    });

    function initTerminal() {
        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª
        term = new Terminal({
            cursorBlink: true,
            cursorStyle: 'block',
            fontSize: 14,
            fontFamily: 'Consolas, Monaco, "Courier New", monospace',
            theme: {
                background: '#1e1e1e',
                foreground: '#d4d4d4',
                cursor: '#d4d4d4',
                black: '#000000',
                red: '#cd3131',
                green: '#0dbc79',
                yellow: '#e5e510',
                blue: '#2472c8',
                magenta: '#bc3fbc',
                cyan: '#11a8cd',
                white: '#e5e5e5',
                brightBlack: '#666666',
                brightRed: '#f14c4c',
                brightGreen: '#23d18b',
                brightYellow: '#f5f543',
                brightBlue: '#3b8eea',
                brightMagenta: '#d670d6',
                brightCyan: '#29b8db',
                brightWhite: '#e5e5e5'
            },
            allowTransparency: false,
            scrollback: 1000,
            tabStopWidth: 4
        });

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º –∞–¥–æ–Ω—ã
        fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        const webLinksAddon = new WebLinksAddon.WebLinksAddon();
        term.loadAddon(webLinksAddon);

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        term.writeln('\x1b[1;32m‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\x1b[0m');
        term.writeln('\x1b[1;32m‚ïë         –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –≤–µ–±-—Ç–µ—Ä–º–∏–Ω–∞–ª!                ‚ïë\x1b[0m');
        term.writeln('\x1b[1;32m‚ïë    –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã                ‚ïë\x1b[0m');
        term.writeln('\x1b[1;32m‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\x1b[0m');
        term.writeln('');

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
            if (fitAddon) {
                fitAddon.fit();
                if (isConnected && socket) {
                    socket.emit('resize', {
                        cols: term.cols,
                        rows: term.rows
                    });
                }
            }
        });
    }

    function startTerminal() {
        if (isConnected) {
            console.log('Terminal already connected');
            return;
        }

        console.log('%cüöÄ –ó–∞–ø—É—Å–∫ –≤–µ–±-—Ç–µ—Ä–º–∏–Ω–∞–ª–∞...', 'color: #0dbc79; font-size: 14px; font-weight: bold');
        term.writeln('\x1b[1;36m[–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...]\x1b[0m');

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
        socket = io('/terminal', {
            transports: ['websocket', 'polling']
        });

        socket.on('connect', function () {
            console.log('%c‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω', 'color: #0dbc79; font-weight: bold');
            console.log('Transport:', socket.io.engine.transport.name);
            updateStatus(true);
            term.writeln('\x1b[1;32m[‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É]\x1b[0m');

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω—É—é —Å–µ—Å—Å–∏—é
            console.log('üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∑–∞–ø—É—Å–∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞...');
            socket.emit('start_terminal', {
                cols: term.cols,
                rows: term.rows
            });
        });

        socket.on('connected', function (data) {
            console.log('%c‚úÖ Terminal ready:', 'color: #0dbc79; font-weight: bold', data);
        });

        socket.on('started', function (data) {
            console.log('%c‚úÖ Terminal started successfully!', 'color: #0dbc79; font-weight: bold', data);
            console.log('Session ID:', data.session_id || 'N/A');
            term.clear();
            term.writeln('\x1b[1;32m‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\x1b[0m');
            term.writeln('\x1b[1;32m‚ïë   ‚úì –í–µ–±-—Ç–µ—Ä–º–∏–Ω–∞–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!     ‚ïë\x1b[0m');
            term.writeln('\x1b[1;32m‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\x1b[0m');
            term.writeln('');

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            term.onData(function (data) {
                socket.emit('input', { data: data });
            });
        });

        socket.on('output', function (data) {
            // –í—ã–≤–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª
            term.write(data.data);
        });

        socket.on('error', function (data) {
            console.error('%c‚ùå Terminal error:', 'color: #cd3131; font-weight: bold', data);
            term.writeln('\r\n\x1b[1;31m‚ùå –û—à–∏–±–∫–∞: ' + data.message + '\x1b[0m\r\n');
        });

        socket.on('disconnect', function () {
            console.log('%cüîå Disconnected from terminal server', 'color: #e5e510; font-weight: bold');
            updateStatus(false);
            term.writeln('\r\n\x1b[1;33m[‚ö† –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ]\x1b[0m\r\n');
        });

        socket.on('connect_error', function (error) {
            console.error('%c‚ùå Connection error:', 'color: #cd3131; font-weight: bold', error);
            term.writeln('\r\n\x1b[1;31m‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message + '\x1b[0m\r\n');
            term.writeln('\x1b[1;33m–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ Gunicorn —Å eventlet\x1b[0m\r\n');
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        document.getElementById('start-btn').disabled = true;
        document.getElementById('stop-btn').disabled = false;
    }

    function stopTerminal() {
        console.log('%cüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞...', 'color: #e5e510; font-size: 14px; font-weight: bold');
        
        if (socket) {
            socket.disconnect();
            socket = null;
            console.log('‚úÖ Socket –æ—Ç–∫–ª—é—á–µ–Ω');
        }

        updateStatus(false);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        document.getElementById('start-btn').disabled = false;
        document.getElementById('stop-btn').disabled = true;

        term.writeln('\r\n\x1b[1;33m[üõë –¢–µ—Ä–º–∏–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω]\x1b[0m\r\n');
        console.log('%c‚úì –¢–µ—Ä–º–∏–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'color: #0dbc79');
    }

    function clearTerminal() {
        if (term) {
            term.clear();
        }
    }

    function updateStatus(connected) {
        isConnected = connected;
        const indicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');

        if (connected) {
            indicator.classList.remove('disconnected');
            indicator.classList.add('connected');
            statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
        } else {
            indicator.classList.remove('connected');
            indicator.classList.add('disconnected');
            statusText.textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
        }
    }
</script>
{% endblock %}
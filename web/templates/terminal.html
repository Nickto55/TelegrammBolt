{% extends "base.html" %}

{% block title %}–í–µ–±-—Ç–µ—Ä–º–∏–Ω–∞–ª - TelegrammBolt{% endblock %}

{% block extra_head %}
<!-- Xterm.js –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>

<!-- Socket.IO –¥–ª—è WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<style>
    .terminal-container {
        background-color: #1e1e1e;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .terminal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        margin: -20px -20px 0 -20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .terminal-header h2 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
    }

    .terminal-controls {
        display: flex;
        gap: 10px;
    }

    .terminal-btn {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .terminal-btn.start {
        background-color: #10b981;
        color: white;
    }

    .terminal-btn.start:hover {
        background-color: #059669;
    }

    .terminal-btn.stop {
        background-color: #ef4444;
        color: white;
    }

    .terminal-btn.stop:hover {
        background-color: #dc2626;
    }

    .terminal-btn.clear {
        background-color: #6b7280;
        color: white;
    }

    .terminal-btn.clear:hover {
        background-color: #4b5563;
    }

    .terminal-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    #terminal {
        margin-top: 20px;
        height: 500px;
        border-radius: 0 0 8px 8px;
    }

    .terminal-info {
        background-color: #f3f4f6;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .terminal-info h3 {
        margin: 0 0 10px 0;
        color: #374151;
        font-size: 1rem;
    }

    .terminal-info ul {
        margin: 0;
        padding-left: 20px;
        color: #6b7280;
    }

    .terminal-info li {
        margin: 5px 0;
    }

    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-indicator.connected {
        background-color: #10b981;
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
    }

    .status-indicator.disconnected {
        background-color: #ef4444;
    }

    .status-text {
        font-size: 0.9rem;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1>
                <i class="fas fa-terminal">
            </h1>

            <div class="terminal-container">
                <div class="terminal-header">
                    <div>
                        <h2>
                            <i class="fas fa-code"></i>

                            <span class="status-indicator disconnected" id="status-indicator"></span>
                            <span class="status-text" id="status-text">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
                        </h2>
                    </div>
                    <div class="terminal-controls">
                        <button class="terminal-btn start" id="start-btn" onclick="startTerminal()">
                            <i class="fas fa-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å
                        </button>
                        <button class="terminal-btn stop" id="stop-btn" onclick="stopTerminal()" disabled>
                            <i class="fas fa-stop"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                        <button class="terminal-btn clear" id="clear-btn" onclick="clearTerminal()">
                            <i class="fas fa-eraser"></i> –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                    </div>
                </div>
                <div id="terminal"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let term;
    let fitAddon;
    let socket;
    let isConnected = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function () {
        console.log('%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó', 'color: #667eea; font-weight: bold');
        console.log('%c‚ïë              –í–µ–±-—Ç–µ—Ä–º–∏–Ω–∞–ª TelegramBolt                 ‚ïë', 'color: #667eea; font-weight: bold');
        console.log('%c‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù', 'color: #667eea; font-weight: bold');
        console.log('%c–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞...', 'color: #2472c8');

        initTerminal();

        console.log('%c–¢–µ—Ä–º–∏–Ω–∞–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'color: #0dbc79; font-weight: bold');
        console.log('%c–ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã', 'color: #e5e510');
        console.log('%c–†–∞–∑–º–µ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:', 'color: #2472c8', term.cols + 'x' + term.rows);
    });

    function initTerminal() {
        console.log('–°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞...');
        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª
        term = new Terminal({
            cursorBlink: true,
            cursorStyle: 'block',
            fontSize: 14,
            fontFamily: 'Consolas, Monaco, "Courier New", monospace',
            theme: {
                background: '#1e1e1e',
                foreground: '#d4d4d4',
                cursor: '#d4d4d4',
                black: '#000000',
                red: '#cd3131',
                green: '#0dbc79',
                yellow: '#e5e510',
                blue: '#2472c8',
                magenta: '#bc3fbc',
                cyan: '#11a8cd',
                white: '#e5e5e5',
                brightBlack: '#666666',
                brightRed: '#f14c4c',
                brightGreen: '#23d18b',
                brightYellow: '#f5f543',
                brightBlue: '#3b8eea',
                brightMagenta: '#d670d6',
                brightCyan: '#29b8db',
                brightWhite: '#e5e5e5'
            },
            allowTransparency: false,
            scrollback: 1000,
            tabStopWidth: 4
        });

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º –∞–¥–æ–Ω—ã
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π —Ç–µ—Ä–º–∏–Ω–∞–ª–∞...');
        fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        console.log('FitAddon –∑–∞–≥—Ä—É–∂–µ–Ω');

        const webLinksAddon = new WebLinksAddon.WebLinksAddon();
        term.loadAddon(webLinksAddon);
        console.log('WebLinksAddon –∑–∞–≥—Ä—É–∂–µ–Ω');

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
        console.log('–û—Ç–∫—Ä—ã—Ç–∏–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –≤ DOM...');
        term.open(document.getElementById('terminal'));
        fitAddon.fit();
        console.log('–¢–µ—Ä–º–∏–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç –∏ –ø–æ–¥–æ–≥–Ω–∞–Ω –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞');



        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
            if (fitAddon) {
                fitAddon.fit();
                console.log('üìè –†–∞–∑–º–µ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω:', term.cols + 'x' + term.rows);
                if (isConnected && socket) {
                    socket.emit('resize', {
                        cols: term.cols,
                        rows: term.rows
                    });
                    console.log('–ù–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
                }
            }
        });
    }

    function startTerminal() {
        if (isConnected) {
            console.log('Terminal already connected');
            return;
        }

        console.log('%c–ó–∞–ø—É—Å–∫ –≤–µ–±-—Ç–µ—Ä–º–∏–Ω–∞–ª–∞...', 'color: #0dbc79; font-size: 14px; font-weight: bold');
        term.writeln('\x1b[1;36m[–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...]\x1b[0m');

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
        socket = io('/terminal', {
            transports: ['websocket', 'polling']
        });

        socket.on('connect', function () {
            console.log('%cWebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω', 'color: #0dbc79; font-weight: bold');
            console.log('Transport:', socket.io.engine.transport.name);
            updateStatus(true);
            term.writeln('\x1b[1;32m[–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É]\x1b[0m');

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            term.onData(function (data) {
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –≤–≤–æ–¥–∞:', data.replace(/\r/g, '\\r').replace(/\n/g, '\\n'));
                if (socket && isConnected) {
                    socket.emit('input', { data: data });
                }
            });

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω—É—é —Å–µ—Å—Å–∏—é
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∑–∞–ø—É—Å–∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞...');
            socket.emit('start_terminal', {
                cols: term.cols,
                rows: term.rows
            });
        });

        socket.on('connected', function (data) {
            console.log('%cTerminal ready:', 'color: #0dbc79; font-weight: bold', data);
        });

        socket.on('started', function (data) {
            console.log('%cTerminal started successfully!', 'color: #0dbc79; font-weight: bold', data);
            console.log('Session ID:', data.session_id || 'N/A');
            term.clear();
            term.writeln('\x1b[1;32m –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ.\x1b[0m');
            term.writeln('');
        });

        socket.on('output', function (data) {
            // –í—ã–≤–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª
            term.write(data.data);
        });

        socket.on('error', function (data) {
            console.error('%cTerminal error:', 'color: #cd3131; font-weight: bold', data);
            term.writeln('\r\n\x1b[1;31m–û—à–∏–±–∫–∞: ' + data.message + '\x1b[0m\r\n');
        });

        socket.on('disconnect', function () {
            console.log('%cDisconnected from terminal server', 'color: #e5e510; font-weight: bold');
            updateStatus(false);
            term.writeln('\r\n\x1b[1;33m[‚ö† –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ]\x1b[0m\r\n');
        });

        socket.on('connect_error', function (error) {
            console.error('%cConnection error:', 'color: #cd3131; font-weight: bold', error);
            term.writeln('\r\n\x1b[1;31m–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message + '\x1b[0m\r\n');
            term.writeln('\x1b[1;33m–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ Gunicorn —Å eventlet\x1b[0m\r\n');
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        document.getElementById('start-btn').disabled = true;
        document.getElementById('stop-btn').disabled = false;
    }

    function stopTerminal() {
        console.log('%c–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞...', 'color: #e5e510; font-size: 14px; font-weight: bold');

        if (socket) {
            socket.disconnect();
            socket = null;
            console.log('Socket –æ—Ç–∫–ª—é—á–µ–Ω');
        }

        updateStatus(false);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        document.getElementById('start-btn').disabled = false;
        document.getElementById('stop-btn').disabled = true;

        term.writeln('\r\n\x1b[1;33m[–¢–µ—Ä–º–∏–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω]\x1b[0m\r\n');
        console.log('%c–¢–µ—Ä–º–∏–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'color: #0dbc79');
    }

    function clearTerminal() {
        console.log('–û—á–∏—Å—Ç–∫–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞...');
        if (term) {
            term.clear();
            console.log('–¢–µ—Ä–º–∏–Ω–∞–ª –æ—á–∏—â–µ–Ω');
        }
    }

    function updateStatus(connected) {
        isConnected = connected;
        console.log('Status updated:', connected ? 'Connected' : 'Disconnected');
        const indicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');

        if (connected) {
            indicator.classList.remove('disconnected');
            indicator.classList.add('connected');
            statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
        } else {
            indicator.classList.remove('connected');
            indicator.classList.add('disconnected');
            statusText.textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
        }
    }
</script>
{% endblock %}
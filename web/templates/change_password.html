{% extends "base.html" %}

{% block title %}Смена пароля{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">Смена пароля</h3>
                </div>
                <div class="card-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Текущий пароль</label>
                            <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">Новый пароль</label>
                            <input type="password" class="form-control" id="newPassword" name="newPassword" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label for="confirmNewPassword" class="form-label">Подтвердите новый пароль</label>
                            <input type="password" class="form-control" id="confirmNewPassword" name="confirmNewPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Сменить пароль</button>
                    </form>
                    <div id="messageArea" class="mt-3" style="display: none;"></div>
                </div>
            </div>
            <div class="text-center mt-3">
                <a href="{{ url_for('profile') }}">Вернуться в профиль</a>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    const messageArea = document.getElementById('messageArea');
    
    // Проверка совпадения новых паролей
    if (newPassword !== confirmNewPassword) {
        showMessage('Новый пароль и подтверждение не совпадают', 'danger');
        return;
    }
    
    // Проверка длины нового пароля
    if (newPassword.length < 6) {
        showMessage('Новый пароль должен быть не менее 6 символов', 'danger');
        return;
    }
    
    // Хэшируем пароли
    const hashedCurrentPassword = await sha256(currentPassword);
    const hashedNewPassword = await sha256(newPassword);
    
    try {
        const response = await fetch('/api/profile/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                currentPassword: hashedCurrentPassword,
                newPassword: hashedNewPassword
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage(result.message || 'Пароль успешно изменен!', 'success');
            // Очищаем форму
            document.getElementById('changePasswordForm').reset();
        } else {
            showMessage(result.error || 'Ошибка при смене пароля', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage('Ошибка соединения с сервером', 'danger');
    }
});

function showMessage(message, type) {
    const messageArea = document.getElementById('messageArea');
    messageArea.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    messageArea.style.display = 'block';
    
    // Автоматически скрываем сообщение через 5 секунд
    setTimeout(() => {
        messageArea.style.display = 'none';
    }, 5000);
}

// Функция для хэширования пароля (sha256)
async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);                     // encode as UTF-8
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);    // hash the message
    const hashArray = Array.from(new Uint8Array(hashBuffer));               // convert ArrayBuffer to Array
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); // convert bytes to hex string
    return hashHex;
}
</script>
{% endblock %}
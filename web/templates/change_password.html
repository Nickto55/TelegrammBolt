{% extends "base.html" %}

{% block title %}{% if has_password %}Смена пароля{% else %}Создание пароля{% endif %}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">{% if has_password %}Смена пароля{% else %}Создание логина и пароля{% endif %}</h3>
                </div>
                <div class="card-body">
                    {% if not has_password %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Вы можете создать логин и пароль для входа в систему без Telegram
                    </div>
                    {% endif %}
                    
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Логин (email или имя пользователя)</label>
                            <input type="text" class="form-control" id="username" name="username" 
                                   value="{{ current_username }}" required
                                   placeholder="your_login или email@example.com">
                            <small class="form-text text-muted">Этот логин будет использоваться для входа</small>
                        </div>
                        
                        {% if has_password %}
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Текущий пароль</label>
                            <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
                        </div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">{% if has_password %}Новый пароль{% else %}Пароль{% endif %}</label>
                            <input type="password" class="form-control" id="newPassword" name="newPassword" required minlength="6">
                            <small class="form-text text-muted">Минимум 6 символов</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirmNewPassword" class="form-label">Подтвердите пароль</label>
                            <input type="password" class="form-control" id="confirmNewPassword" name="confirmNewPassword" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            {% if has_password %}Сменить пароль{% else %}Создать пароль{% endif %}
                        </button>
                    </form>
                    <div id="messageArea" class="mt-3" style="display: none;"></div>
                </div>
            </div>
            <div class="text-center mt-3">
                <a href="{{ url_for('profile') }}">Вернуться в профиль</a>
            </div>
        </div>
    </div>
</div>

<script>
const hasPassword = {{ 'true' if has_password else 'false' }};

document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const currentPassword = hasPassword ? document.getElementById('currentPassword').value : '';
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    const messageArea = document.getElementById('messageArea');
    
    // Проверка логина
    if (!username) {
        showMessage('Необходимо указать логин', 'danger');
        return;
    }
    
    // Проверка совпадения новых паролей
    if (newPassword !== confirmNewPassword) {
        showMessage('Пароль и подтверждение не совпадают', 'danger');
        return;
    }
    
    // Проверка длины нового пароля
    if (newPassword.length < 6) {
        showMessage('Пароль должен быть не менее 6 символов', 'danger');
        return;
    }
    
    // Хэшируем пароли
    const hashedCurrentPassword = hasPassword ? await sha256(currentPassword) : '';
    const hashedNewPassword = await sha256(newPassword);
    
    try {
        const response = await fetch('/api/profile/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                currentPassword: hashedCurrentPassword,
                newPassword: hashedNewPassword
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage(result.message || 'Пароль успешно сохранён!', 'success');
            // Перезагружаем страницу через 2 секунды
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showMessage(result.error || 'Ошибка при сохранении пароля', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage('Ошибка соединения с сервером', 'danger');
    }
});

function showMessage(message, type) {
    const messageArea = document.getElementById('messageArea');
    messageArea.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    messageArea.style.display = 'block';
    
    // Автоматически скрываем сообщение через 5 секунд
    if (type !== 'success') {
        setTimeout(() => {
            messageArea.style.display = 'none';
        }, 5000);
    }
}

// Функция для хэширования пароля (sha256)
async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);                     // encode as UTF-8
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);    // hash the message
    const hashArray = Array.from(new Uint8Array(hashBuffer));               // convert ArrayBuffer to Array
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); // convert bytes to hex string
    return hashHex;
}
</script>
{% endblock %}
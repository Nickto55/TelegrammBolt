{% extends "base.html" %}

{% block title %}dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Уведомление для пользователей без Telegram -->
    {% if session.auth_type == 'qr' and not session.get('telegram_linked') %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <h5 class="alert-heading">
                    <i class="bi bi-info-circle"></i> Вход через QR код
                </h5>
                <p class="mb-2">
                    Вы вошли через QR код с ролью <strong>{{ session.user_role|title }}</strong>. 
                    Для получения роли администратора и полного доступа к функциям необходимо:
                </p>
                <ol class="mb-3">
                    <li>Подключить Telegram аккаунт к системе</li>
                    <li>Обратиться к администратору для назначения роли</li>
                </ol>
                <a href="https://t.me/{{ bot_username }}" class="btn btn-primary" target="_blank">
                    <i class="bi bi-telegram"></i> Открыть бота в Telegram
                </a>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Быстрые действия - ПЕРЕНЕСЛИ ВВЕРХ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Быстрые действия</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% if permissions.create_dse %}
                        <div class="col-md-3">
                            <a href="{{ url_for('create_dse') }}" class="btn btn-outline-success w-100 py-3">
                                <i class="bi bi-plus-circle display-6 d-block mb-2"></i>
                                Создать заявку
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if permissions.view_dse %}
                        <div class="col-md-3">
                            <a href="{{ url_for('dse_list') }}" class="btn btn-outline-primary w-100 py-3">
                                <i class="bi bi-list-ul display-6 d-block mb-2"></i>
                                Просмотр заявок
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if permissions.manage_users %}
                        <div class="col-md-3">
                            <a href="{{ url_for('users_management') }}" class="btn btn-outline-secondary w-100 py-3">
                                <i class="bi bi-people display-6 d-block mb-2"></i>
                                Управление пользователями
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if permissions.export_excel %}
                        <div class="col-md-3">
                            <button class="btn btn-outline-info w-100 py-3" onclick="exportExcel()">
                                <i class="bi bi-file-earmark-excel display-6 d-block mb-2"></i>
                                Экспорт Excel
                            </button>
                        </div>
                        {% endif %}
                        
                        {% if permissions.chat %}
                        <div class="col-md-3">
                            <a href="{{ url_for('chat') }}" class="btn btn-outline-warning w-100 py-3">
                                <i class="bi bi-chat-left-text display-6 d-block mb-2"></i>
                                Открыть чат
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Статистика (только для admin и responder с дополнительным правом) -->
    {% if permissions.view_dashboard_stats and stats %}
    <div class="row g-3 mb-4">
        <div class="col-lg-4 col-md-6">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">В работе</h6>
                            <h2 class="card-title mb-0">{{ stats.total_dse }}</h2>
                        </div>
                        <i class="bi bi-list-ul display-4 opacity-50"></i>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <a href="{{ url_for('dse_list') }}" class="text-white text-decoration-none">
                        Перейти к списку <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Активные пользователи</h6>
                            <h2 class="card-title mb-0">{{ stats.active_users }}</h2>
                        </div>
                        <i class="bi bi-people display-4 opacity-50"></i>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <small class="text-white">Пользователей в системе</small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">За неделю</h6>
                            <h2 class="card-title mb-0">{{ stats.recent_dse }}</h2>
                        </div>
                        <i class="bi bi-calendar-week display-4 opacity-50"></i>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <small class="text-white">Добавленно новых записей</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Диаграмма распределения по типам проблем -->
    {% if stats.problem_types %}
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Распределение по типам проблем</h5>
                </div>
                <div class="card-body">
                    <canvas id="problemTypesChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Статистика по типам</h5>
                    <div class="status-slider compact">
                        <div class="status-bubble" id="statusBubble" aria-hidden="true"></div>
                        <input type="range" class="form-range" min="0" max="2" step="1" value="1" id="statusFilterRange" aria-label="Фильтр по статусу">
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Тип проблемы</th>
                                    <th class="text-end">Количество</th>
                                    <th class="text-end">%</th>
                                </tr>
                            </thead>
                            <tbody id="problemTypesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% else %}
    <!-- Информационное сообщение для пользователей без прав на просмотр статистики -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-body text-center py-5">
                    <i class="bi bi-info-circle display-1 text-info mb-3"></i>
                    <h4>Добро пожаловать!</h4>
                    <p class="text-muted">
                        Используйте быстрые действия выше для работы с системой.
                        {% if session.user_role == 'initiator' %}
                        <br><strong>Роль инициатора:</strong> Вы можете создавать заявки и использовать чат для своих заявок.
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Последние заявки -->
    {% if permissions.view_dse %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Последние заявки</h5>
                    <a href="{{ url_for('dse_list') }}" class="btn btn-sm btn-primary">
                        Показать все
                    </a>
                </div>
                <div class="card-body">
                    <div id="recent-dse">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
    .status-slider {
        position: relative;
        padding-top: 24px;
    }

    .status-slider.compact {
        width: 12.5%;
        min-width: 110px;
    }

    .status-slider .form-range {
        width: 100%;
        height: 28px;
    }

    .status-slider .form-range::-webkit-slider-runnable-track {
        height: 30px;
        background: linear-gradient(80deg, #56a8e7 0%, #56a8e7 90%);
        border-radius: 999px;
    }

    .status-slider .form-range::-moz-range-track {
        height: 29px;
        background: #56a8e7;
        border-radius: 999px;
    }

    .status-slider .form-range::-webkit-slider-thumb {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #2873ac;
        border: 2px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
        margin-top: 0;
    }

    .status-slider .form-range::-moz-range-thumb {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #2873ac;
        border: 2px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
    }

    .status-bubble {
        position: absolute;
        top: 0;
        transform: translateX(-90%);
        background: #093658;
        color: #ffffff;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        line-height: 1.2;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        white-space: nowrap;
    }

    .status-bubble.show {
        opacity: 1;
    }
</style>

<script>
const dseDataForStats = {{ dse_data|tojson }};

const STATUS_FILTERS = {
    0: 'all',
    1: 'in_progress',
    2: 'completed'
};

function normalizeStatus(record) {
    const raw = (record.status || '').toString().trim().toLowerCase();
    if (raw === 'выполнена' || raw === 'решено') {
        return 'completed';
    }
    return 'in_progress';
}

function filterByStatus(records, mode) {
    if (mode === 'all') return records;
    return records.filter(record => normalizeStatus(record) === mode);
}

function buildProblemStats(records) {
    const counts = {};
    records.forEach(record => {
        const type = record.problem_type || 'Неизвестно';
        counts[type] = (counts[type] || 0) + 1;
    });
    return counts;
}

function renderProblemTypesTable(counts) {
    const tbody = document.getElementById('problemTypesTableBody');
    if (!tbody) return;
    const entries = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    const total = entries.reduce((sum, item) => sum + item[1], 0);

    if (!entries.length) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Нет данных</td></tr>';
        return;
    }

    tbody.innerHTML = entries.map(([type, count]) => {
        const percent = total ? ((count / total) * 100).toFixed(1) : '0.0';
        return `
            <tr>
                <td>${type}</td>
                <td class="text-end"><strong>${count}</strong></td>
                <td class="text-end">${percent}%</td>
            </tr>
        `;
    }).join('');
}

let problemTypesChart = null;

function renderProblemTypesChart(counts) {
    const ctx = document.getElementById('problemTypesChart');
    if (!ctx) return;

    const entries = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    const labels = entries.map(([label]) => label);
    const data = entries.map(([, value]) => value);

    if (!problemTypesChart) {
        problemTypesChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: [
                        'rgba(30, 94, 255, 0.8)',
                        'rgba(0, 212, 255, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(201, 203, 207, 0.8)'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } else {
        problemTypesChart.data.labels = labels;
        problemTypesChart.data.datasets[0].data = data;
        problemTypesChart.update();
    }
}

function updateProblemStats(mode) {
    const filtered = filterByStatus(dseDataForStats, mode);
    const counts = buildProblemStats(filtered);
    renderProblemTypesTable(counts);
    renderProblemTypesChart(counts);
}

// Данные для диаграммы
const statusRange = document.getElementById('statusFilterRange');
const statusBubble = document.getElementById('statusBubble');
const STATUS_LABELS = {
    all: 'Все',
    in_progress: 'В работе',
    completed: 'Завершённые'
};

let bubbleTimer = null;

function updateStatusBubble(mode) {
    if (!statusRange || !statusBubble) return;
    const min = Number(statusRange.min || 0);
    const max = Number(statusRange.max || 2);
    const val = Number(statusRange.value || 1);
    const percent = max === min ? 0 : ((val - min) / (max - min));
    const sliderWidth = statusRange.offsetWidth;
    const left = percent * sliderWidth;

    statusBubble.textContent = STATUS_LABELS[mode] || '';
    statusBubble.style.left = `${left}px`;
    statusBubble.classList.add('show');

    if (bubbleTimer) {
        clearTimeout(bubbleTimer);
    }
    bubbleTimer = setTimeout(() => {
        statusBubble.classList.remove('show');
    }, 1400);
}
if (statusRange) {
    statusRange.addEventListener('input', () => {
        const mode = STATUS_FILTERS[Number(statusRange.value)] || 'in_progress';
        updateProblemStats(mode);
        updateStatusBubble(mode);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const mode = statusRange ? STATUS_FILTERS[Number(statusRange.value)] : 'in_progress';
    updateProblemStats(mode || 'in_progress');
    updateStatusBubble(mode || 'in_progress');
});

// Загрузка последних ДСЕ
document.addEventListener('DOMContentLoaded', function() {
    loadRecentDse();
});

function loadRecentDse() {
    fetch('/api/dse')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('recent-dse');
            if (data.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Нет данных для отображения</p>';
                return;
            }
            
            // Сортируем по дате (последние сначала) и показываем последние 5
            const sortedData = data.sort((a, b) => {
                const dateA = new Date(a.datetime || 0);
                const dateB = new Date(b.datetime || 0);
                return dateB - dateA; // От новых к старым
            });
            
            const recent = sortedData.slice(0, 5);
            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead><tr><th>ДСЕ</th><th>Тип проблемы</th><th>Описание</th><th>Дата</th><th></th></tr></thead><tbody>';
            
            recent.forEach(dse => {
                const description = dse.description || 'Без описания';
                const shortDesc = description.length > 50 ? description.substring(0, 50) + '...' : description;
                const dateParam = dse.datetime || dse.created_at || dse.date || '';
                const dseLink = dateParam
                    ? `/dse/${encodeURIComponent(dse.dse)}?date=${encodeURIComponent(dateParam)}`
                    : `/dse/${encodeURIComponent(dse.dse)}`;
                html += `
                    <tr>
                        <td><strong>${dse.dse || '-'}</strong></td>
                        <td><span class="badge bg-info">${dse.problem_type || 'Не указано'}</span></td>
                        <td>${shortDesc}</td>
                        <td><small>${dse.datetime || '-'}</small></td>
                        <td><a href="${dseLink}" class="btn btn-sm btn-outline-primary">Просмотр</a></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading DSE:', error);
            document.getElementById('recent-dse').innerHTML = 
                '<p class="text-center text-danger">Ошибка загрузки данных</p>';
        });
}

function addNewDse() {
    // TODO: Открыть модальное окно для добавления ДСЕ
    alert('Функция добавления ДСЕ будет реализована');
}

function exportExcel() {
    window.location.href = '/api/export/excel';
}

function generatePdf() {
    // TODO: Открыть диалог генерации PDF
    alert('Функция генерации PDF будет реализована');
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}statement review{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Хлебные крошки -->
    <nav aria-label="breadcrumb" class="mt-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Главная</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('dse_list') }}">ДСЕ</a></li>
            <li class="breadcrumb-item active">{{ dse.get('dse', 'N/A') }} - {{ dse.get('dse_name', 'N/A') }}</li>
        </ol>
    </nav>

    <!-- Заголовок -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-file-earmark-text me-2"></i>
            Детали заявки ДСЕ
            {% if dse.get('hidden') %}
            <span class="badge bg-secondary ms-2">Скрыто</span>
            {% endif %}
        </h1>
        <div class="d-flex gap-2">
            {% if permissions.close_dse %}
                {% set dse_status = dse.get('status') or 'В работе' %}
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#statusModal">
                    <i class="bi bi-arrow-repeat me-1"></i>
                    Изменить статус
                </button>
                {% if dse_status != 'Выполнена' %}
                <button class="btn btn-outline-success" onclick="closeDse('{{ dse.get('id') }}')">
                    <i class="bi bi-check2-circle me-1"></i>
                    Закрыть
                </button>
                {% endif %}
            {% endif %}
            {% if permissions.delete_dse %}
                {% if dse.get('hidden') %}
                <button class="btn btn-outline-success" onclick="restoreDse('{{ dse.get('id') }}')">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>
                    Восстановить
                </button>
                {% else %}
                <button class="btn btn-outline-danger" onclick="hideDse('{{ dse.get('id') }}')">
                    <i class="bi bi-eye-slash me-1"></i>
                    Скрыть
                </button>
                {% endif %}
            {% endif %}
            <a href="{{ url_for('dse_list') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>
                Назад к списку
            </a>
        </div>
    </div>

    <!-- Основная информация -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Основная информация
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        {% set dse_status = dse.get('status') or 'В работе' %}
                        <div class="col-md-6">
                            <label class="text-muted small mb-1">Номер ДСЕ</label>
                            <h4 class="text-primary">{{ dse.get('dse', 'N/A') }}</h4>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small mb-1">Название ДСЕ</label>
                            <h4 class="text-primary">{{ dse.get('dse_name', 'N/A') }}</h4>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small mb-1">Дата создания</label>
                            <h5>{{ dse.get('datetime', 'N/A') }}</h5>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small mb-1">Статус</label>
                            <p class="mb-0">
                                <span class="badge fs-6 {% if dse_status == 'Выполнена' %}bg-success{% elif dse_status == 'Отклонена' %}bg-danger{% elif dse_status == 'В работе' %}bg-info text-dark{% else %}bg-secondary{% endif %}">
                                    {{ dse_status }}
                                </span>
                            </p>
                        </div>
                    </div>

                    <hr>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted small mb-1">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                Тип проблемы
                            </label>
                            <p class="mb-0">
                                <span class="badge bg-warning text-dark fs-6">
                                    {{ dse.get('problem_type', 'N/A') }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small mb-1">
                                <i class="bi bi-building me-1"></i>
                                РЦ
                            </label>
                            <p class="mb-0 fs-5">{{ dse.get('rc', 'N/A') }}</p>
                        </div>
                    </div>

                    <hr>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="text-muted small mb-1">
                                <i class="bi bi-gear me-1"></i>
                                Номер станка
                            </label>
                            <p class="mb-0 fs-5">{{ dse.get('machine_number', 'N/A') }}</p>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small mb-1">
                                <i class="bi bi-person-badge me-1"></i>
                                ФИО Наладчика
                            </label>
                            <p class="mb-0 fs-5">{{ dse.get('installer_fio', 'N/A') }}</p>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small mb-1">
                                <i class="bi bi-code-slash me-1"></i>
                                ФИО Программиста
                            </label>
                            <p class="mb-0 fs-5">{{ dse.get('programmer_name', 'N/A') }}</p>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <label class="text-muted small mb-1">
                            <i class="bi bi-chat-left-text me-1"></i>
                            Описание проблемы
                        </label>
                        <div class="border rounded p-3 bg-light">
                            <p class="mb-0" style="white-space: pre-wrap;">{{ dse.get('description', 'Описание отсутствует') }}</p>
                        </div>
                    </div>

                    {% if dse.get('sent_to_emails') %}
                    <hr>
                    <div class="mb-0">
                        <label class="text-muted small mb-1">
                            <i class="bi bi-envelope me-1"></i>
                            Отправлено на email
                        </label>
                        <p class="mb-0">{{ dse.get('sent_to_emails', 'N/A') }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if dse.get('related_records') %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-diagram-3 me-2"></i>
                        Связанные заявки
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for related in dse.get('related_records', []) %}
                        <div class="col-md-6">
                            {% set related_photos = related.get('photos') or [] %}
                            {% set related_photo_id = related.get('photo_file_id') or related.get('photo_path') or (related_photos[0] if related_photos else None) %}
                            <div class="border rounded p-3 h-100 bg-light related-card"
                                 role="button"
                                 tabindex="0"
                                 data-related='{{ related | tojson | forceescape }}'
                                 {% if related_photo_id %}data-photo-url="{{ url_for('get_photo', photo_id=related_photo_id) }}"{% endif %}>
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="fw-semibold">{{ related.get('dse', 'N/A') }}</div>
                                    <span class="badge bg-secondary">{{ related.get('record_id', '—') }}</span>
                                </div>
                                <div class="text-muted small mb-2">
                                    {{ related.get('dse_name', 'Без названия') }}
                                </div>
                                <div class="small">
                                    <div><span class="text-muted">Пользователь:</span> {{ related.get('user_id', '—') }}</div>
                                    <div><span class="text-muted">Индекс:</span> {{ related.get('index', '—') }}</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Фотографии -->
            {% if dse.get('photo_file_id') or dse.get('photo_path') or dse.get('photos') %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-images me-2"></i>
                        Прикрепленные фото
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% if dse.get('photo_file_id') %}
                        <div class="col-md-6">
                            <div class="position-relative">
                                <img src="{{ url_for('get_photo', photo_id=dse.get('photo_file_id')) }}" 
                                     class="img-fluid rounded shadow-sm photo-with-error" 
                                     alt="Фото ДСЕ"
                                     style="cursor: pointer; min-height: 200px; object-fit: cover;"
                                     data-bs-toggle="modal" 
                                     data-bs-target="#photoModal0"
                                     onerror="this.style.cursor='default'; this.removeAttribute('data-bs-toggle');">
                                <div class="position-absolute top-0 end-0 m-2">
                                    <a href="{{ url_for('get_photo', photo_id=dse.get('photo_file_id')) }}" 
                                       download="dse_{{ dse.get('dse', 'photo') }}.jpg"
                                       class="btn btn-sm btn-light"
                                       title="Скачать фото">
                                        <i class="bi bi-download"></i>
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Modal для увеличения фото -->
                            <div class="modal fade" id="photoModal0" tabindex="-1">
                                <div class="modal-dialog modal-lg modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Фото ДСЕ {{ dse.get('dse', '') }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body text-center">
                                            <img src="{{ url_for('get_photo', photo_id=dse.get('photo_file_id')) }}" 
                                                 class="img-fluid" 
                                                 alt="Фото ДСЕ">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% elif dse.get('photo_path') %}
                        <div class="col-md-6">
                            <div class="position-relative">
                                <img src="{{ url_for('get_photo', photo_id=dse.get('photo_path')) }}" 
                                     class="img-fluid rounded shadow-sm" 
                                     alt="Фото ДСЕ"
                                     style="cursor: pointer; min-height: 200px; object-fit: cover;"
                                     data-bs-toggle="modal" 
                                     data-bs-target="#photoModalPath">
                                <div class="position-absolute top-0 end-0 m-2">
                                    <a href="{{ url_for('get_photo', photo_id=dse.get('photo_path')) }}" 
                                       download="dse_{{ dse.get('dse', 'photo') }}.jpg"
                                       class="btn btn-sm btn-light"
                                       title="Скачать фото">
                                        <i class="bi bi-download"></i>
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Modal для увеличения фото -->
                            <div class="modal fade" id="photoModalPath" tabindex="-1">
                                <div class="modal-dialog modal-lg modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Фото ДСЕ {{ dse.get('dse', '') }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body text-center">
                                            <img src="{{ url_for('get_photo', photo_id=dse.get('photo_path')) }}" 
                                                 class="img-fluid" 
                                                 alt="Фото ДСЕ">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if dse.get('photos') %}
                            {% for photo_id in dse.get('photos', []) %}
                            <div class="col-md-6">
                                <div class="position-relative">
                                    <img src="{{ url_for('get_photo', photo_id=photo_id) }}" 
                                         class="img-fluid rounded shadow-sm" 
                                         alt="Фото {{ loop.index }}"
                                         style="cursor: pointer;"
                                         data-bs-toggle="modal" 
                                         data-bs-target="#photoModal{{ loop.index }}">
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <a href="{{ url_for('get_photo', photo_id=photo_id) }}" 
                                           download="dse_{{ dse.get('dse', 'photo') }}_{{ loop.index }}.jpg"
                                           class="btn btn-sm btn-light">
                                            <i class="bi bi-download"></i>
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- Modal для увеличения фото -->
                                <div class="modal fade" id="photoModal{{ loop.index }}" tabindex="-1">
                                    <div class="modal-dialog modal-lg modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Фото {{ loop.index }} - ДСЕ {{ dse.get('dse', '') }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body text-center">
                                                <img src="{{ url_for('get_photo', photo_id=photo_id) }}" 
                                                     class="img-fluid" 
                                                     alt="Фото {{ loop.index }}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                К этой заявке не прикреплены фотографии
            </div>
            {% endif %}
        </div>

        <!-- Боковая панель -->
        <div class="col-lg-4">
            <!-- Информация о пользователе -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person me-2"></i>
                        Автор заявки
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>ID пользователя:</strong><br>
                        <code>{{ dse.get('user_id', 'N/A') }}</code>
                    </p>
                    {% if user_info %}
                    <p class="mb-2">
                        <strong>Имя:</strong><br>
                        {{ user_info.get('name', 'N/A') }}
                    </p>
                    <p class="mb-0">
                        <strong>Отдел:</strong><br>
                        {{ user_info.get('department', 'N/A') }}
                    </p>
                    {% endif %}
                </div>
            </div>

            <!-- Статистика -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-bar-chart me-2"></i>
                        Статистика
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Фотографий:</span>
                        <strong>
                            {% if dse.get('photo_file_id') %}
                                1
                            {% elif dse.get('photos') %}
                                {{ dse.get('photos', [])|length }}
                            {% else %}
                                0
                            {% endif %}
                        </strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Email уведомлений:</span>
                        <strong>
                            {% if dse.get('sent_to_emails') %}
                                {{ dse.get('sent_to_emails').split(',')|length }}
                            {% else %}
                                0
                            {% endif %}
                        </strong>
                    </div>
                </div>
            </div>

            <!-- Действия -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-gear me-2"></i>
                        Действия
                    </h5>
                </div>
                <div class="card-body">
                    <a href="{{ url_for('chat') }}?dse={{ dse.get('dse', '') }}" 
                       class="btn btn-info w-100 mb-2">
                        <i class="bi bi-chat-dots me-2"></i>
                        Открыть чат по ДСЕ
                    </a>
                    <a href="{{ url_for('pdf_export_page') }}?preselect={{ dse.get('dse', '') }}" 
                       class="btn btn-primary w-100 mb-2">
                        <i class="bi bi-file-pdf me-2"></i>
                        PDF отчёт
                    </a>
                    {% if permissions.export_data %}
                    <a href="{{ url_for('pdf_export_page') }}?preselect={{ dse.get('dse', '') }}" 
                       class="btn btn-danger w-100 mb-2">
                        <i class="bi bi-file-pdf me-2"></i>
                        Экспорт в PDF
                    </a>
                    <a href="{{ url_for('dse_list') }}?export=excel&dse={{ dse.get('dse', '') }}" 
                       class="btn btn-outline-success w-100">
                        <i class="bi bi-file-excel me-2"></i>
                        Экспорт в Excel
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно изменения статуса -->
{% if permissions.close_dse %}
{% set dse_status = dse.get('status') or 'В работе' %}
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalLabel">Изменить статус заявки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="statusSelect" class="form-label">Статус</label>
                    <select class="form-select" id="statusSelect">
                        <option value="В работе" {% if dse_status == 'В работе' %}selected{% endif %}>В работе</option>
                        <option value="Выполнена" {% if dse_status == 'Выполнена' %}selected{% endif %}>Выполнена</option>
                        <option value="Отклонена" {% if dse_status == 'Отклонена' %}selected{% endif %}>Отклонена</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="updateDseStatus('{{ dse.get('id') }}')">Сохранить</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Модальное окно для связанной заявки -->
<div class="modal fade" id="relatedDseModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="relatedDseTitle">Связанная заявка</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="text-muted small mb-1">Номер ДСЕ</label>
                        <div class="fw-semibold" id="relatedDseNumber">—</div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small mb-1">Название ДСЕ</label>
                        <div class="fw-semibold" id="relatedDseName">—</div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small mb-1">Дата создания</label>
                        <div id="relatedDseDatetime">—</div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small mb-1">Тип проблемы</label>
                        <div id="relatedDseProblem">—</div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small mb-1">РЦ</label>
                        <div id="relatedDseRc">—</div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small mb-1">Номер станка</label>
                        <div id="relatedDseMachine">—</div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small mb-1">ФИО Наладчика</label>
                        <div id="relatedDseInstaller">—</div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small mb-1">ФИО Программиста</label>
                        <div id="relatedDseProgrammer">—</div>
                    </div>
                    <div class="col-12">
                        <label class="text-muted small mb-1">Описание</label>
                        <div class="border rounded p-2 bg-light" id="relatedDseDescription">—</div>
                    </div>
                    <div class="col-12" id="relatedDsePhotoBlock" style="display: none;">
                        <label class="text-muted small mb-2">Фото</label>
                        <div class="text-center">
                            <img id="relatedDsePhoto" src="" alt="Фото" class="img-fluid rounded shadow-sm" style="max-height: 420px; object-fit: contain;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .related-card {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .related-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
    }
    @media print {
        .btn, .breadcrumb, nav, .modal {
            display: none !important;
        }
    }
</style>

<script>
    function fillRelatedModal(data, photoUrl) {
        document.getElementById('relatedDseTitle').textContent = `Связанная заявка ${data.dse || ''}`.trim();
        document.getElementById('relatedDseNumber').textContent = data.dse || '—';
        document.getElementById('relatedDseName').textContent = data.dse_name || '—';
        document.getElementById('relatedDseDatetime').textContent = data.datetime || '—';
        document.getElementById('relatedDseProblem').textContent = data.problem_type || '—';
        document.getElementById('relatedDseRc').textContent = data.rc || '—';
        document.getElementById('relatedDseMachine').textContent = data.machine_number || '—';
        document.getElementById('relatedDseInstaller').textContent = data.installer_fio || '—';
        document.getElementById('relatedDseProgrammer').textContent = data.programmer_name || '—';
        document.getElementById('relatedDseDescription').textContent = data.description || '—';

        const photoBlock = document.getElementById('relatedDsePhotoBlock');
        const photoEl = document.getElementById('relatedDsePhoto');
        if (photoUrl) {
            photoEl.src = photoUrl;
            photoBlock.style.display = 'block';
        } else {
            photoEl.removeAttribute('src');
            photoBlock.style.display = 'none';
        }
    }

    document.querySelectorAll('.related-card').forEach(card => {
        const openModal = () => {
            const raw = card.getAttribute('data-related');
            if (!raw) return;
            let data;
            try {
                data = JSON.parse(raw);
            } catch (e) {
                return;
            }
            const photoUrl = card.getAttribute('data-photo-url');
            fillRelatedModal(data, photoUrl);
            const modal = new bootstrap.Modal(document.getElementById('relatedDseModal'));
            modal.show();
        };

        card.addEventListener('click', openModal);
        card.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                openModal();
            }
        });
    });
</script>
{% endblock %}

{% block extra_scripts %}
<script>
function hideDse(dseId) {
    showConfirm('Скрыть эту заявку из списка? Она останется в базе.', () => {
        fetch(`/api/dse/${encodeURIComponent(dseId)}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(() => window.location.reload())
            .catch(error => {
                console.error('Ошибка скрытия:', error);
                showToast('Ошибка скрытия заявки', 'danger');
            });
    }, { okVariant: 'danger' });
}

function restoreDse(dseId) {
    fetch(`/api/dse/${encodeURIComponent(dseId)}/restore`, { method: 'POST' })
        .then(response => response.json())
        .then(() => window.location.reload())
        .catch(error => console.error('Ошибка восстановления:', error));
}

function closeDse(dseId) {
    showConfirm('Закрыть эту заявку как выполненную?', () => {
        fetch(`/api/dse/${encodeURIComponent(dseId)}/close`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data && data.error) {
                    showToast(data.error, 'danger');
                    return;
                }
                window.location.reload();
            })
            .catch(error => {
                console.error('Ошибка закрытия:', error);
                showToast('Ошибка закрытия заявки', 'danger');
            });
    }, { okVariant: 'success' });
}

function updateDseStatus(dseId) {
    const statusSelect = document.getElementById('statusSelect');
    const status = statusSelect ? statusSelect.value : '';
    if (!status) {
        showToast('Выберите статус', 'warning');
        return;
    }

    fetch(`/api/dse/${encodeURIComponent(dseId)}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
    })
        .then(response => response.json())
        .then(data => {
            if (data && data.error) {
                showToast(data.error, 'danger');
                return;
            }
            window.location.reload();
        })
        .catch(error => {
            console.error('Ошибка обновления статуса:', error);
            showToast('Ошибка обновления статуса', 'danger');
        });
}
</script>
{% endblock %}

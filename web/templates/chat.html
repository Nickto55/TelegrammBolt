{% extends "base.html" %}

{% block title %}Чат - TelegrammBolt{% endblock %}

{% block extra_head %}
<style>
    .chat-container {
        height: calc(100vh - 250px);
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: var(--bs-light);
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .message {
        margin-bottom: 15px;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 70%;
        word-wrap: break-word;
    }
    
    .message-sent {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }
    
    .message-received {
        background-color: white;
        color: #333;
        margin-right: auto;
        border: 1px solid #dee2e6;
    }
    
    .message-info {
        font-size: 0.75rem;
        opacity: 0.8;
        margin-top: 5px;
    }
    
    .chat-input-container {
        display: flex;
        gap: 10px;
        padding: 15px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    
    .chat-input {
        flex: 1;
    }
    
    .online-users {
        background-color: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .user-status {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .user-online {
        background-color: #28a745;
    }
    
    .user-offline {
        background-color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-chat-dots"></i> Чат
            </h1>
        </div>
    </div>
    
    <div class="row">
        <!-- Список пользователей -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-people"></i> Участники</h5>
                </div>
                <div class="card-body">
                    <div id="usersList">
                        <p class="text-muted">Загрузка...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Чат -->
        <div class="col-md-9">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    {% if messages %}
                        {% for msg in messages %}
                        <div class="message {% if msg.is_own %}message-sent{% else %}message-received{% endif %}">
                            <div class="message-content">
                                {% if not msg.is_own %}
                                <strong>{{ msg.username }}</strong><br>
                                {% endif %}
                                {{ msg.text }}
                            </div>
                            <div class="message-info">
                                {{ msg.timestamp }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-chat-text display-1 d-block mb-3"></i>
                        <p>Нет сообщений. Начните общение!</p>
                    </div>
                    {% endif %}
                </div>
                
                <div class="chat-input-container">
                    <input 
                        type="text" 
                        class="form-control chat-input" 
                        id="messageInput" 
                        placeholder="Введите сообщение..."
                        autocomplete="off"
                    >
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="bi bi-send"></i> Отправить
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentUserId = {{ session.user_id|default(0) }};
let pollingInterval;

// Загрузка списка пользователей
function loadUsers() {
    fetch('/api/users/list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const usersList = document.getElementById('usersList');
                let html = '<div class="list-group list-group-flush">';
                
                data.users.forEach(user => {
                    const isOnline = user.is_online || false;
                    const statusClass = isOnline ? 'user-online' : 'user-offline';
                    const statusText = isOnline ? 'онлайн' : 'оффлайн';
                    
                    html += `
                        <div class="list-group-item px-0">
                            <span class="user-status ${statusClass}"></span>
                            ${user.username || user.first_name || 'Пользователь'}
                            <small class="text-muted">(${statusText})</small>
                        </div>
                    `;
                });
                
                html += '</div>';
                usersList.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки пользователей:', error);
        });
}

// Отправка сообщения
function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    
    if (!text) return;
    
    fetch('/api/chat/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            text: text
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            loadMessages();
        } else {
            alert('Ошибка отправки сообщения');
        }
    })
    .catch(error => {
        console.error('Ошибка отправки:', error);
        alert('Ошибка отправки сообщения');
    });
}

// Загрузка сообщений
function loadMessages() {
    fetch('/api/chat/messages')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const chatMessages = document.getElementById('chatMessages');
                const scrolledToBottom = chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 100;
                
                let html = '';
                
                if (data.messages.length === 0) {
                    html = `
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-chat-text display-1 d-block mb-3"></i>
                            <p>Нет сообщений. Начните общение!</p>
                        </div>
                    `;
                } else {
                    data.messages.forEach(msg => {
                        const isOwn = msg.user_id === currentUserId;
                        const messageClass = isOwn ? 'message-sent' : 'message-received';
                        
                        html += `
                            <div class="message ${messageClass}">
                                <div class="message-content">
                                    ${!isOwn ? '<strong>' + (msg.username || 'Пользователь') + '</strong><br>' : ''}
                                    ${msg.text}
                                </div>
                                <div class="message-info">
                                    ${msg.timestamp}
                                </div>
                            </div>
                        `;
                    });
                }
                
                chatMessages.innerHTML = html;
                
                // Прокрутка вниз если был внизу
                if (scrolledToBottom) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки сообщений:', error);
        });
}

// Отправка по Enter
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('messageInput');
    
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Начальная загрузка
    loadUsers();
    loadMessages();
    
    // Автообновление каждые 3 секунды
    pollingInterval = setInterval(() => {
        loadMessages();
        loadUsers();
    }, 3000);
    
    // Прокрутка вниз при загрузке
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
});

// Очистка интервала при уходе со страницы
window.addEventListener('beforeunload', function() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
});
</script>
{% endblock %}

#!/bin/bash
# TelegrammBolt - ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð´Ð»Ñ Debian/Ubuntu
# Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹

set -e

echo "ðŸš€ TelegrammBolt - ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°"
echo "============================================================"

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
apt-get update
apt-get install -y python3 python3-pip python3-venv git curl wget build-essential

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
echo "ðŸ‘¤ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ telegrambot..."
if ! id "telegrambot" &>/dev/null; then
    useradd --system --shell /bin/bash --home /opt/telegrambot --create-home telegrambot
fi

# ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
echo "ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
if [ -d "/opt/telegrambot/.git" ]; then
    cd /opt/telegrambot
    sudo -u telegrambot git pull
else
    rm -rf /opt/telegrambot
    git clone https://github.com/Nickto55/TelegrammBolt.git /opt/telegrambot
fi

chown -R telegrambot:telegrambot /opt/telegrambot

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
echo "ðŸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
cd /opt/telegrambot
sudo -u telegrambot python3 -m venv .venv
sudo -u telegrambot .venv/bin/pip install --upgrade pip
sudo -u telegrambot .venv/bin/pip install -r requirements.txt

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
echo "âš™ï¸ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."
if [ ! -f "ven_bot.json" ]; then
    sudo -u telegrambot bash -c 'cat > ven_bot.json << EOF
{
  "BOT_TOKEN": "YOUR_BOT_TOKEN_HERE",
  "ADMIN_IDS": ["YOUR_TELEGRAM_ID_HERE"]
}
EOF'
fi

if [ ! -f "smtp_config.json" ]; then
    sudo -u telegrambot bash -c 'cat > smtp_config.json << EOF
{
  "SMTP_SERVER": "smtp.gmail.com",
  "SMTP_PORT": 587,
  "SMTP_USER": "your_email@gmail.com",
  "SMTP_PASSWORD": "your_app_password",
  "FROM_NAME": "TelegrammBolt"
}
EOF'
fi

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° systemd ÑÐ»ÑƒÐ¶Ð±Ñ‹
echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ»ÑƒÐ¶Ð±Ñ‹..."
cp /opt/telegrambot/telegrambot.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable telegrambot.service

echo
echo "============================================================"
echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo
echo "ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
echo "1. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ:"
echo "   nano /opt/telegrambot/ven_bot.json"
echo
echo "2. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð±Ð¾Ñ‚Ð°:"
echo "   systemctl start telegrambot"
echo
echo "3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑ:"
echo "   systemctl status telegrambot"
echo
echo "4. ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð²:"
echo "   journalctl -u telegrambot -f"
echo "============================================================"

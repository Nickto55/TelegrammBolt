# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ 502 Bad Gateway

## –ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç 502 Bad Gateway?

```
502 Bad Gateway
nginx/1.24.0
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
- ‚úÖ **Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç** (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 80 –∏ 443)
- ‚ùå **Flask –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç** (–Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 5000)

Nginx –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é.

---

## üöÄ –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –®–∞–≥ 1: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

```bash
cd /opt/telegrambot
bash fix-502.sh
```

–°–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∂–µ—Ç **—Ç–æ—á–Ω—É—é –ø—Ä–∏—á–∏–Ω—É** –ø—Ä–æ–±–ª–µ–º—ã.

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞

```bash
cd /opt/telegrambot
python3 bot.py
```

–ò–ª–∏ —á–µ—Ä–µ–∑ systemd:
```bash
sudo systemctl start telegrambot
sudo systemctl status telegrambot
```

**Flask –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ bot.py!**  
–ï—Å–ª–∏ –±–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí Flask –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí 502 Bad Gateway

---

## üîç –†—É—á–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç
```bash
sudo systemctl status nginx
```
–î–æ–ª–∂–Ω–æ –±—ã—Ç—å: **Active (running)**

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω
```bash
ps aux | grep bot.py
```
–î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ—Ü–µ—Å—Å: `python3 bot.py`

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Flask —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 5000
```bash
sudo netstat -tulpn | grep :5000
```
–î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `127.0.0.1:5000 ... LISTEN`

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Flask –æ—Ç–≤–µ—á–∞–µ—Ç
```bash
curl http://127.0.0.1:5000/login
```
–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ–≥–∏–Ω–∞ (–Ω–µ –æ—à–∏–±–∫—É).

---

## ‚ùå –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

### –ü—Ä–∏—á–∏–Ω–∞ 1: –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω ‚≠ê –°–ê–ú–ê–Ø –ß–ê–°–¢–ê–Ø

**–°–∏–º–ø—Ç–æ–º—ã:**
- `ps aux | grep bot.py` ‚Üí –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç
- –ü–æ—Ä—Ç 5000 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
```bash
cd /opt/telegrambot
python3 bot.py &
```

–ò–ª–∏ —á–µ—Ä–µ–∑ systemd:
```bash
sudo systemctl start telegrambot
```

### –ü—Ä–∏—á–∏–Ω–∞ 2: web_enabled = false

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω
- –ù–æ –ø–æ—Ä—Ç 5000 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è
- –í –ª–æ–≥–∞—Ö –Ω–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏—è "–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–ø—É—â–µ–Ω"

**–†–µ—à–µ–Ω–∏–µ:**
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ `ven_bot.json`:
```bash
cat ven_bot.json
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```json
{
  "BOT_TOKEN": "...",
  "ADMIN_IDS": [...],
  "web_enabled": true,
  "web_port": 5000
}
```

–ï—Å–ª–∏ `"web_enabled": false` ‚Üí –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ `true` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.

### –ü—Ä–∏—á–∏–Ω–∞ 3: –ü–æ—Ä—Ç 5000 –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- –û—à–∏–±–∫–∞: `Address already in use`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ù–∞–π—Ç–∏ —á—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –ø–æ—Ä—Ç
sudo lsof -i :5000

# –£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å (–∑–∞–º–µ–Ω–∏—Ç–µ PID)
sudo kill -9 <PID>

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
python3 bot.py
```

### –ü—Ä–∏—á–∏–Ω–∞ 4: –û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ –±–æ—Ç–∞/Flask

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –Ω–æ —Å—Ä–∞–∑—É –ø–∞–¥–∞–µ—Ç
- Flask –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
tail -50 bot.log

# –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤ foreground (—É–≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫–∏)
python3 bot.py
```

–ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ.

### –ü—Ä–∏—á–∏–Ω–∞ 5: Firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç localhost

**–°–∏–º–ø—Ç–æ–º—ã:**
- Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç
- Flask —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ù–æ 502 –≤—Å—ë —Ä–∞–≤–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å iptables
sudo iptables -L

# –†–∞–∑—Ä–µ—à–∏—Ç—å localhost
sudo iptables -A INPUT -i lo -j ACCEPT
sudo iptables -A OUTPUT -o lo -j ACCEPT

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx
sudo systemctl restart nginx
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã
```bash
# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω Nginx
ps aux | grep nginx

# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω bot.py
ps aux | grep bot.py
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç—ã
```bash
sudo netstat -tulpn | grep -E ':(80|443|5000)'

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# tcp  0.0.0.0:80     ... nginx    (HTTP)
# tcp  0.0.0.0:443    ... nginx    (HTTPS)
# tcp  127.0.0.1:5000 ... python3  (Flask)
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Flask –ª–æ–∫–∞–ª—å–Ω–æ
```bash
curl -I http://127.0.0.1:5000/login

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# HTTP/1.1 200 OK
# –∏–ª–∏
# HTTP/1.1 302 Found
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ Nginx
```bash
curl -k -I https://localhost/

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# HTTP/2 200
# –∏–ª–∏
# HTTP/2 302
```

### 5. –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
```
https://87.120.166.213/
```

–î–æ–ª–∂–Ω–∞ –æ—Ç–∫—Ä—ã—Ç—å—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ª–æ–≥–∏–Ω–∞ (–ù–ï –æ—à–∏–±–∫–∞ 502).

---

## üìã –ß–µ–∫–ª–∏—Å—Ç —Ä–µ—à–µ–Ω–∏—è 502

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ –ø–æ—Ä—è–¥–∫—É:

- [ ] Nginx –∑–∞–ø—É—â–µ–Ω: `sudo systemctl status nginx`
- [ ] –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω: `ps aux | grep bot.py`
- [ ] –ü–æ—Ä—Ç 5000 —Å–ª—É—à–∞–µ—Ç—Å—è: `sudo netstat -tulpn | grep :5000`
- [ ] Flask –æ—Ç–≤–µ—á–∞–µ—Ç: `curl http://127.0.0.1:5000/login`
- [ ] web_enabled=true –≤ ven_bot.json
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö: `tail -50 bot.log`
- [ ] Nginx –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω: `sudo nginx -t`

–ï—Å–ª–∏ –≤—Å–µ –ø—É–Ω–∫—Ç—ã ‚úÖ ‚Üí 502 –∏—Å—á–µ–∑–Ω–µ—Ç.

---

## üõ†Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

–°–∫—Ä–∏–ø—Ç `fix-502.sh` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –ù–∞–π–¥—ë—Ç –ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–±–ª–µ–º—ã
- –ü–æ–∫–∞–∂–µ—Ç —á—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ (–µ—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```bash
cd /opt/telegrambot
bash fix-502.sh
```

---

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–ë—Ä–∞—É–∑–µ—Ä
   ‚Üì
   ‚Üì HTTPS (443)
   ‚Üì
Nginx (–ø–æ—Ä—Ç—ã 80, 443)
   ‚Üì
   ‚Üì HTTP (localhost)
   ‚Üì
Flask (127.0.0.1:5000) ‚Üê –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ bot.py!
   ‚Üì
bot.py (Telegram Bot)
```

**–í–∞–∂–Ω–æ:** Flask –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **–≤–Ω—É—Ç—Ä–∏ bot.py —á–µ—Ä–µ–∑ threading**.  
–ï—Å–ª–∏ bot.py –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí Flask –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí 502 Bad Gateway.

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞

–ß—Ç–æ–±—ã –±–æ—Ç (–∏ Flask) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–ª—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ:

```bash
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å service —Ñ–∞–π–ª
sudo cp telegrambot.service /etc/systemd/system/

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å systemd
sudo systemctl daemon-reload

# –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
sudo systemctl enable telegrambot

# –ó–∞–ø—É—Å—Ç–∏—Ç—å
sudo systemctl start telegrambot

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
sudo systemctl status telegrambot
```

–¢–µ–ø–µ—Ä—å –±–æ—Ç –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

---

## üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
cd /opt/telegrambot && python3 bot.py &

# –ß–µ—Ä–µ–∑ systemd
sudo systemctl start telegrambot

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
sudo pkill -f bot.py
# –∏–ª–∏
sudo systemctl stop telegrambot

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
sudo systemctl restart telegrambot

# –õ–æ–≥–∏ –±–æ—Ç–∞
tail -f bot.log

# –õ–æ–≥–∏ Nginx
sudo tail -f /var/log/nginx/telegrambot_error.log

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç—ã
sudo netstat -tulpn | grep -E ':(80|443|5000)'

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Flask
curl http://127.0.0.1:5000/login

# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
bash fix-502.sh
```

---

## üéØ –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞

| –û—à–∏–±–∫–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|--------|---------|---------|
| 502 Bad Gateway | Flask –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | –ó–∞–ø—É—Å—Ç–∏—Ç—å bot.py |
| 400 Bad Request | HTTP –Ω–∞ HTTPS –ø–æ—Ä—Ç | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å https:// |
| 404 Not Found | –ù–µ–≤–µ—Ä–Ω—ã–π URL | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—É—Ç—å |
| Connection refused | Nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω | `sudo systemctl start nginx` |
| Timeout | Firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç | –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—ã 80, 443 |

---

**–ì–ª–∞–≤–Ω–æ–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç–µ `bot.py` ‚Üí Flask –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí 502 –∏—Å—á–µ–∑–Ω–µ—Ç! üöÄ
